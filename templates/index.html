{% extends 'base.html' %}

{% block title %}BMI Calculator{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title mb-0">BMI Calculator</h3>
            <small class="text-muted">Check your fitness status</small>
          </div>
          <div>
            {% if not username %}
            <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm me-2">Sign In</a>
            <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">Sign Up</a>
            {% else %}
            <span class="me-2">Signed in as <strong>{{ username }}</strong></span>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Logout</a>
            {% endif %}
          </div>
        </div>

        <form id="bmiForm">
          <div class="mb-3">
            <label for="weight" class="form-label">Weight</label>
            <div class="input-group">
              <input type="number" class="form-control" id="weight" placeholder="Enter your weight" min="1" step="0.1" required>
              <select id="weight_unit" class="form-select" style="max-width: 110px;">
                <option value="kg" selected>kg</option>
                <option value="lb">lb</option>
              </select>
            </div>
            <div class="form-text">Enter weight and choose unit</div>
          </div>

          <div class="mb-3">
            <label for="height" class="form-label">Height</label>
            <div class="input-group">
              <input type="number" class="form-control" id="height" placeholder="Enter your height" min="1" step="0.1" required>
              <select id="height_unit" class="form-select" style="max-width: 110px;">
                <option value="cm" selected>cm</option>
                <option value="in">in</option>
              </select>
            </div>
            <div class="form-text">Enter height and choose unit</div>
          </div>

          <button type="submit" class="btn btn-primary w-100">Calculate BMI</button>
        </form>

        <div class="mt-3" id="error" style="display:none;"></div>

        <div class="mt-3 card" id="result" style="display:none;">
          <div class="card-body text-center">
            <h4 id="bmiValue"></h4>
            <p id="bmiLabel">Your BMI is</p>
            <div id="status" class="fw-bold p-2 rounded"></div>

            <div class="mt-3">
              <div class="d-flex justify-content-between small text-muted">
                <span>Underweight</span>
                <span>Normal</span>
                <span>Overweight</span>
                <span>Obese</span>
              </div>
              <div class="position-relative bg-light rounded" style="height:30px;">
                <div id="pointer" style="position:absolute; top: -8px; width:2px; height:46px; background:#000; left:0%"></div>
              </div>
              <div class="text-center small text-muted mt-2">18.5 --- 25 --- 30</div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
const form = document.getElementById('bmiForm');
const resultDiv = document.getElementById('result');
const errorDiv = document.getElementById('error');
const bmiValue = document.getElementById('bmiValue');
const statusDiv = document.getElementById('status');
const pointer = document.getElementById('pointer');

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const weight = parseFloat(document.getElementById('weight').value);
  const height = parseFloat(document.getElementById('height').value);
  const unit = document.getElementById('weight_unit').value;
  const height_unit = document.getElementById('height_unit').value;

  errorDiv.style.display = 'none';

  try {
    const response = await fetch('/calculate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ weight, height, weight_unit: unit, height_unit })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || 'Invalid input');

    bmiValue.textContent = data.bmi;
    statusDiv.textContent = data.status;
    statusDiv.className = 'fw-bold p-2 rounded ' + (data.color || '');

    let pointerPosition = 0;
    if (data.bmi < 18.5) {
      pointerPosition = (data.bmi / 18.5) * 25;
    } else if (data.bmi < 25) {
      pointerPosition = 25 + ((data.bmi - 18.5) / 6.5) * 25;
    } else if (data.bmi < 30) {
      pointerPosition = 50 + ((data.bmi - 25) / 5) * 25;
    } else {
      pointerPosition = 75 + Math.min(((data.bmi - 30) / 20) * 25, 25);
    }

    pointer.style.left = pointerPosition + '%';
    resultDiv.style.display = 'block';
  } catch (err) {
    errorDiv.textContent = err.message || 'An error occurred';
    errorDiv.className = 'alert alert-danger';
    errorDiv.style.display = 'block';
    resultDiv.style.display = 'none';
  }
});
</script>
{% endblock %}